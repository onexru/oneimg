import{_ as M,r as n,w as O,o as x,a as B,c as b,b as h,d as k,e as s,t as y,n as P,f as L,v as T,g as S,h as R,m as v}from"./index-BcmoEdYw.js";const I={class:"login"},N={key:0,class:"global-loading"},V={class:"loading-card"},q={class:"loading-title"},H={class:"loading-text"},z={class:"loading-progress"},D={class:"card-body"},J={class:"form-group"},W=["disabled"],F={class:"form-group"},A=["disabled"],G={class:"form-group"},K=["disabled"],Q={class:"modal-header"},X=["disabled"],Y={__name:"Login",setup(Z){const l=n(!1),i=n(""),c=n(""),p=n(!1),a=n(!1),m=n(""),f=n(""),g=n(0),d=(o,e,t=0)=>{a.value=!0,m.value=o,f.value=e,g.value=t},r=()=>{a.value=!1,m.value="",f.value="",g.value=0},U=()=>{if(!a.value){if(!i.value||!c.value){v.warning("请输入用户名和密码");return}d("正在启动","准备安全验证...",10),setTimeout(()=>{l.value=!0},500)}};O(l,o=>{o?setTimeout(()=>{d("加载验证","正在初始化验证组件...",30),_()},800):w()});const _=()=>{if(p.value)return;const o=document.getElementById("pow-container");if(!o){setTimeout(_,200);return}o.innerHTML='<pow-widget id="pow" data-pow-api-endpoint="https://cha.eta.im/"></pow-widget>',d("等待验证","请完成人机验证...",50),r(),setTimeout(j,500)},j=()=>{const o=document.querySelector("#pow");o.addEventListener("solve",function(e){const t=e.detail.token;C({detail:{token:t}})}),o.addEventListener("error",function(e){v.error("验证失败，请重试！")})},u=()=>{l.value=!1,r(),w()},w=()=>{p.value&&(p.value=!1);const o=document.getElementById("pow-container");if(o){const e=o.querySelector("#pow");if(e&&typeof e.remove=="function")try{e.remove()}catch{o.innerHTML=""}else o.innerHTML=""}},C=o=>{const e=o.detail.token;console.log("🎯 获取到POW token:",e),setTimeout(()=>{E(e)},500)},E=async o=>{d("登录中","正在验证用户信息...",90);try{const e=await fetch("/api/login",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({username:i.value,password:c.value,powToken:o})}),t=await e.json();e.ok&&t.success?(localStorage.setItem("userInfo",JSON.stringify({username:i.value})),d("登录成功","即将跳转到主页...",100),setTimeout(()=>{r(),l.value=!1,window.location.href="/"},1500)):(r(),v.error("登录失败: "+(t.message||"未知错误")),u())}catch(e){r(),v.error("登录请求失败，请检查网络连接: "+e.message),u()}};return x(()=>{if(!URL.revokeObjectUrl&&URL.revokeObjectURL&&(URL.revokeObjectUrl=URL.revokeObjectURL),!document.querySelector('script[src="https://cha.eta.im/static/js/pow.min.js"]')){const o=document.createElement("script");o.src="https://cha.eta.im/static/js/pow.min.js",document.head.appendChild(o)}}),B(()=>{w()}),(o,e)=>(h(),b("div",I,[a.value?(h(),b("div",N,[s("div",V,[e[3]||(e[3]=s("div",{class:"loading-spinner"},null,-1)),s("h3",q,y(m.value),1),s("p",H,y(f.value),1),s("div",z,[s("div",{class:"progress-bar",style:P({width:g.value+"%"})},null,4)])])])):k("",!0),s("div",{class:S(["card",{"card-disabled":a.value}])},[s("div",D,[e[6]||(e[6]=s("h5",{class:"card-title"},"登录",-1)),s("div",J,[e[4]||(e[4]=s("label",{for:"username",class:"form-label"},"用户名",-1)),L(s("input",{type:"text","onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),class:"form-input",placeholder:"用户名",disabled:a.value},null,8,W),[[T,i.value]])]),s("div",F,[e[5]||(e[5]=s("label",{for:"password",class:"form-label"},"密码",-1)),L(s("input",{type:"password","onUpdate:modelValue":e[1]||(e[1]=t=>c.value=t),class:"form-input",placeholder:"密码",disabled:a.value},null,8,A),[[T,c.value]])]),s("div",G,[s("button",{onClick:U,class:"login-btn",disabled:a.value}," 登录 ",8,K)])])],2),l.value?(h(),b("div",{key:1,class:S(["modal-backdrop",{"modal-visible":l.value}]),onClick:u},[s("div",{class:"modal",onClick:e[2]||(e[2]=R(()=>{},["stop"]))},[s("div",Q,[e[7]||(e[7]=s("h3",{class:"modal-title"},"安全验证",-1)),s("button",{class:"modal-close",onClick:u,disabled:a.value},"×",8,X)]),e[8]||(e[8]=s("div",{class:"pow"},[s("div",{id:"pow-container"}),s("p",{class:"pow-tip"},"请完成人机验证以继续登录")],-1))])],2)):k("",!0)]))}},ee=M(Y,[["__scopeId","data-v-001c25b9"]]);export{ee as default};
